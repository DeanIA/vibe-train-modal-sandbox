"""Finalize step â€” merge per-worker manifests and report summary."""

import json
from pathlib import Path

from agents.slackbot.infra import app, rag_vol

from .config import CHROMA_COLLECTION, CHROMA_DIR, index_image

_CHROMA_DIR = Path(CHROMA_DIR)
_MANIFEST_PATH = _CHROMA_DIR / "manifest.json"


@app.function(image=index_image, volumes={"/data": rag_vol}, timeout=60 * 60)
def finalize_index(force: bool = False) -> str:
    """Merge per-worker manifest files into manifest.json and report summary."""
    _CHROMA_DIR.mkdir(parents=True, exist_ok=True)
    if force:
        _reset_collection()
    manifest = _merge_worker_manifests()
    total = _collection_count()
    summary = f"Indexed {total:,} chunks from {len(manifest)} file(s)."
    print(summary, flush=True)
    return summary


def _reset_collection() -> None:
    """Drop the ChromaDB collection and all manifest files."""
    import chromadb
    client = chromadb.PersistentClient(path=CHROMA_DIR)
    try:
        client.delete_collection(CHROMA_COLLECTION)
        print("Deleted existing collection.", flush=True)
    except Exception:
        pass
    for f in _CHROMA_DIR.glob("manifest*.json"):
        f.unlink()
    rag_vol.commit()


def _merge_worker_manifests() -> dict:
    """Merge per-worker manifest files into manifest.json. Returns merged manifest."""
    try:
        manifest = json.loads(_MANIFEST_PATH.read_text())
    except Exception:
        manifest = {}
    for wf in sorted(_CHROMA_DIR.glob("manifest-worker-*.json")):
        try:
            manifest.update(json.loads(wf.read_text()))
            wf.unlink()
        except Exception:
            pass
    _MANIFEST_PATH.write_text(json.dumps(manifest, indent=2))
    rag_vol.commit()
    return manifest


def _collection_count() -> int:
    """Return the number of chunks in the ChromaDB collection."""
    try:
        import chromadb
        client = chromadb.PersistentClient(path=CHROMA_DIR)
        return client.get_collection(CHROMA_COLLECTION).count()
    except Exception:
        return 0
